name: AI Agent - Testing & Evaluation

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'exagent.py'
      - 'agenteval.py'
      - 'redteam.py'
      - 'requirements.txt'
      - '.github/workflows/agent-consumption-multi-env.yml'
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: '0 2 * * 1'  # Run every Monday at 2 AM UTC for weekly security testing

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ================================================================================
  # BUILD AND VALIDATE
  # ================================================================================
  build:
    name: Build and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Python syntax
        run: |
          python -m py_compile exagent.py
          python -m py_compile agenteval.py
          python -m py_compile redteam.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-test-scripts
          path: |
            exagent.py
            agenteval.py
            redteam.py
            requirements.txt
          retention-days: 30

  # ================================================================================
  # DEV ENVIRONMENT - Test Existing Agent
  # ================================================================================
  test-dev:
    name: Test Agent in Dev
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: dev
      url: https://ai.azure.com/build/agents
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-test-scripts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Test Existing Agent
        env:
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT_DEV }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_DEV }}
        run: |
          echo "üß™ Testing existing agent in DEV environment..."
          python exagent.py
          echo "‚úÖ Dev agent testing completed"
        continue-on-error: true

  # ================================================================================
  # TEST ENVIRONMENT - Comprehensive Evaluation & Red Team
  # ================================================================================
  evaluate-test:
    name: Evaluate Agent in Test
    runs-on: ubuntu-latest
    needs: test-dev
    environment:
      name: test
      url: https://ai.azure.com/build/agents
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-test-scripts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: Run Agent Evaluation
        env:
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT_TEST }}
          AZURE_AI_PROJECT_ENDPOINT: ${{ secrets.AZURE_AI_PROJECT_ENDPOINT_TEST }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT_TEST }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY_TEST }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION_TEST }}
          AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_TEST }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_TEST }}
        run: |
          echo "üìä Running agent evaluation in TEST environment..."
          echo "Evaluating: Tool Call Accuracy, Intent Resolution, Task Adherence, Response Completeness"
          python agenteval.py
          echo "‚úÖ Evaluation completed"
        continue-on-error: true

  red-team-test:
    name: Red Team Security Testing
    runs-on: ubuntu-latest
    needs: evaluate-test
    environment:
      name: test
      url: https://ai.azure.com/build/agents
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-test-scripts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}

      - name: Run Red Team Security Testing
        env:
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT_TEST }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT_TEST }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY_TEST }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_TEST }}
        run: |
          echo "üîí Running red team security testing in TEST environment..."
          echo "Testing attack strategies: Easy, Moderate, CharSpace, ROT13, Unicode, CharSwap, Morse, Leetspeak, URL, Binary"
          echo "Risk categories: Violence, HateUnfairness, Sexual, SelfHarm"
          python redteam.py
          echo "‚úÖ Red team testing completed"
        continue-on-error: true
        timeout-minutes: 45

      - name: Upload Red Team Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: redteam-results-test
          path: Financial-Advisor-Redteam-Results.json
          retention-days: 90

      - name: Check Red Team Results
        if: always()
        run: |
          if [ -f "Financial-Advisor-Redteam-Results.json" ]; then
            echo "üìÑ Red team results generated successfully"
            echo "Results file size: $(du -h Financial-Advisor-Redteam-Results.json | cut -f1)"
            echo "Review the artifacts for detailed security findings"
          else
            echo "‚ö†Ô∏è Red team results file not found"
          fi

  # ================================================================================
  # PRODUCTION ENVIRONMENT - Verify Production Agent
  # ================================================================================
  verify-prod:
    name: Verify Production Agent
    runs-on: ubuntu-latest
    needs: red-team-test
    environment:
      name: production
      url: https://ai.azure.com/build/agents
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-test-scripts

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Verify Production Agent
        env:
          AZURE_AI_PROJECT: ${{ secrets.AZURE_AI_PROJECT_PROD }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID_PROD }}
        run: |
          echo "‚úÖ Verifying production agent..."
          python exagent.py
          echo "‚úÖ Production agent verification completed"

      - name: Testing Summary
        run: |
          echo "=============================================="
          echo "AGENT TESTING & EVALUATION COMPLETED"
          echo "=============================================="
          echo "Completed at: $(date)"
          echo "Environments tested: Dev, Test, Production"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "‚úÖ Agent testing completed across all environments"
          echo "üìä Evaluation metrics recorded"
          echo "üîí Security testing performed"
          echo ""
          echo "Review artifacts for detailed results"
