trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - createagent.py
      - exagent.py
      - agenteval.py
      - redteam.py
      - requirements.txt
      - cicd/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  # Global variables - Add these in Azure DevOps as pipeline variables or variable group
  # - AZURE_CLIENT_ID
  # - AZURE_TENANT_ID
  # - AZURE_SUBSCRIPTION_ID

stages:
  # ================================================================================
  # BUILD STAGE - Validate code and run unit tests
  # ================================================================================
  - stage: Build
    displayName: 'Build and Validate'
    jobs:
      - job: ValidateAndTest
        displayName: 'Validate Python Code'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Set Python Version'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python -m py_compile createagent.py
              python -m py_compile exagent.py
              python -m py_compile agenteval.py
              python -m py_compile redteam.py
            displayName: 'Validate Python Syntax'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Artifacts'
            inputs:
              targetPath: '$(Build.SourcesDirectory)'
              artifact: 'agent-scripts'
              publishLocation: 'pipeline'

  # ================================================================================
  # DEV ENVIRONMENT - Create and test agent
  # ================================================================================
  - stage: Dev
    displayName: 'Deploy to Dev'
    dependsOn: Build
    condition: succeeded()
    variables:
      - group: 'agent-dev-vars'  # Variable group for dev environment
      # Expected variables in group:
      # - AZURE_AI_PROJECT_DEV
      # - AZURE_OPENAI_ENDPOINT_DEV
      # - AZURE_OPENAI_KEY_DEV
      # - AZURE_OPENAI_API_VERSION_DEV
      # - AZURE_OPENAI_DEPLOYMENT_DEV
      # - AZURE_AI_PROJECT_ENDPOINT_DEV
      # - AZURE_SERVICE_CONNECTION_DEV
    jobs:
      - deployment: DeployAgentDev
        displayName: 'Deploy Agent to Dev'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Artifacts'
                  inputs:
                    artifact: 'agent-scripts'
                    path: '$(Pipeline.Workspace)/agent-scripts'

                - task: UsePythonVersion@0
                  displayName: 'Set Python Version'
                  inputs:
                    versionSpec: '$(pythonVersion)'
                    addToPath: true

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: 'Install Dependencies'

                - task: AzureCLI@2
                  displayName: 'Test Existing Agent in Dev'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION_DEV)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      export AZURE_AI_PROJECT="$(AZURE_AI_PROJECT_DEV)"
                      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
                      export AZURE_TENANT_ID="$(AZURE_TENANT_ID)"
                      export AZURE_CLIENT_ID="$(AZURE_CLIENT_ID)"
                      
                      echo "Testing existing agent in DEV..."
                      python exagent.py
                    addSpnToEnvironment: true
                    continueOnError: true

  # ================================================================================
  # TEST ENVIRONMENT - Evaluation and Red Team testing
  # ================================================================================
  - stage: Test
    displayName: 'Deploy to Test'
    dependsOn: Dev
    condition: succeeded()
    variables:
      - group: 'agent-test-vars'  # Variable group for test environment
      # Expected variables in group:
      # - AZURE_AI_PROJECT_TEST
      # - AZURE_OPENAI_ENDPOINT_TEST
      # - AZURE_OPENAI_KEY_TEST
      # - AZURE_OPENAI_API_VERSION_TEST
      # - AZURE_OPENAI_DEPLOYMENT_TEST
      # - AZURE_AI_PROJECT_ENDPOINT_TEST
      # - AZURE_SERVICE_CONNECTION_TEST
    jobs:
      - deployment: DeployAgentTest
        displayName: 'Deploy and Evaluate Agent in Test'
        environment: 'test'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Artifacts'
                  inputs:
                    artifact: 'agent-scripts'
                    path: '$(Pipeline.Workspace)/agent-scripts'

                - task: UsePythonVersion@0
                  displayName: 'Set Python Version'
                  inputs:
                    versionSpec: '$(pythonVersion)'
                    addToPath: true

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: 'Install Dependencies'

                - task: AzureCLI@2
                  displayName: 'Run Agent Evaluation'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION_TEST)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      export AZURE_AI_PROJECT="$(AZURE_AI_PROJECT_TEST)"
                      export AZURE_AI_PROJECT_ENDPOINT="$(AZURE_AI_PROJECT_ENDPOINT_TEST)"
                      export AZURE_OPENAI_ENDPOINT="$(AZURE_OPENAI_ENDPOINT_TEST)"
                      export AZURE_OPENAI_KEY="$(AZURE_OPENAI_KEY_TEST)"
                      export AZURE_OPENAI_API_VERSION="$(AZURE_OPENAI_API_VERSION_TEST)"
                      export AZURE_OPENAI_DEPLOYMENT="$(AZURE_OPENAI_DEPLOYMENT_TEST)"
                      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
                      export AZURE_TENANT_ID="$(AZURE_TENANT_ID)"
                      export AZURE_CLIENT_ID="$(AZURE_CLIENT_ID)"
                      
                      echo "Running agent evaluation in TEST..."
                      python agenteval.py
                    addSpnToEnvironment: true
                    continueOnError: true

                - task: AzureCLI@2
                  displayName: 'Run Red Team Testing'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION_TEST)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      export AZURE_AI_PROJECT="$(AZURE_AI_PROJECT_TEST)"
                      export AZURE_OPENAI_ENDPOINT="$(AZURE_OPENAI_ENDPOINT_TEST)"
                      export AZURE_OPENAI_KEY="$(AZURE_OPENAI_KEY_TEST)"
                      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
                      export AZURE_TENANT_ID="$(AZURE_TENANT_ID)"
                      export AZURE_CLIENT_ID="$(AZURE_CLIENT_ID)"
                      
                      echo "Running red team evaluation in TEST..."
                      python redteam.py
                    addSpnToEnvironment: true
                    continueOnError: true

                - task: PublishPipelineArtifact@1
                  displayName: 'Publish Red Team Results'
                  inputs:
                    targetPath: 'Financial-Advisor-Redteam-Results.json'
                    artifact: 'redteam-results-test'
                    publishLocation: 'pipeline'
                  condition: succeededOrFailed()

  # ================================================================================
  # PROD ENVIRONMENT - Production deployment with approval gates
  # ================================================================================
  - stage: Prod
    displayName: 'Deploy to Production'
    dependsOn: Test
    condition: succeeded()
    variables:
      - group: 'agent-prod-vars'  # Variable group for production environment
      # Expected variables in group:
      # - AZURE_AI_PROJECT_PROD
      # - AZURE_OPENAI_ENDPOINT_PROD
      # - AZURE_OPENAI_KEY_PROD
      # - AZURE_OPENAI_API_VERSION_PROD
      # - AZURE_OPENAI_DEPLOYMENT_PROD
      # - AZURE_AI_PROJECT_ENDPOINT_PROD
      # - AZURE_SERVICE_CONNECTION_PROD
    jobs:
      - deployment: DeployAgentProd
        displayName: 'Deploy Agent to Production'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Artifacts'
                  inputs:
                    artifact: 'agent-scripts'
                    path: '$(Pipeline.Workspace)/agent-scripts'

                - task: UsePythonVersion@0
                  displayName: 'Set Python Version'
                  inputs:
                    versionSpec: '$(pythonVersion)'
                    addToPath: true

                - script: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                  displayName: 'Install Dependencies'

                - task: AzureCLI@2
                  displayName: 'Verify Production Agent'
                  inputs:
                    azureSubscription: '$(AZURE_SERVICE_CONNECTION_PROD)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      export AZURE_AI_PROJECT="$(AZURE_AI_PROJECT_PROD)"
                      export AZURE_SUBSCRIPTION_ID="$(AZURE_SUBSCRIPTION_ID)"
                      export AZURE_TENANT_ID="$(AZURE_TENANT_ID)"
                      export AZURE_CLIENT_ID="$(AZURE_CLIENT_ID)"
                      
                      echo "Verifying production agent..."
                      python exagent.py
                    addSpnToEnvironment: true

                - script: |
                    echo "=============================================="
                    echo "PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY"
                    echo "=============================================="
                    echo "Agent deployed at: $(date)"
                    echo "Environment: Production"
                    echo "Pipeline: $(Build.DefinitionName)"
                    echo "Build: $(Build.BuildNumber)"
                  displayName: 'Deployment Summary'
